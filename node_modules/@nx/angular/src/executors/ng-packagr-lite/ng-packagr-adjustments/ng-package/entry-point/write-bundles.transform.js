"use strict";
/**
 * Adapted from the original ng-packagr.
 *
 * Changes made:
 * - Removed bundling altogether.
 * - Write the ESM2022 outputs to the file system.
 * - Fake the FESM2022 outputs pointing them to the ESM2022 outputs.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.writeBundlesTransform = void 0;
const promises_1 = require("node:fs/promises");
const node_path_1 = require("node:path");
const ng_packagr_version_1 = require("../../../../utilities/ng-packagr/ng-packagr-version");
const package_imports_1 = require("../../../../utilities/ng-packagr/package-imports");
const entry_point_1 = require("./entry-point");
const writeBundlesTransform = (_options) => {
    const { major: ngPackagrMajorVersion } = (0, ng_packagr_version_1.getNgPackagrVersionInfo)();
    const { BuildGraph } = (0, package_imports_1.importNgPackagrPath)('ng-packagr/lib/graph/build-graph', ngPackagrMajorVersion);
    const { transformFromPromise } = (0, package_imports_1.importNgPackagrPath)('ng-packagr/lib/graph/transform', ngPackagrMajorVersion);
    const { isEntryPoint, isPackage } = (0, package_imports_1.importNgPackagrPath)('ng-packagr/lib/ng-package/nodes', ngPackagrMajorVersion);
    const { NgPackage } = (0, package_imports_1.importNgPackagrPath)('ng-packagr/lib/ng-package/package', ngPackagrMajorVersion);
    return transformFromPromise(async (graph) => {
        const updatedGraph = new BuildGraph();
        for (const entry of graph.entries()) {
            if (isEntryPoint(entry)) {
                const entryPoint = toCustomNgEntryPoint(entry.data.entryPoint);
                entry.data.entryPoint = entryPoint;
                entry.data.destinationFiles = entryPoint.destinationFiles;
                for (const [path, outputCache] of entry.cache.outputCache.entries()) {
                    // write the outputs to the file system
                    await (0, promises_1.mkdir)((0, node_path_1.dirname)(path), { recursive: true });
                    await (0, promises_1.writeFile)(path, outputCache.content);
                }
            }
            else if (isPackage(entry)) {
                entry.data = new NgPackage(entry.data.src, toCustomNgEntryPoint(entry.data.primary), entry.data.secondaries.map((secondary) => toCustomNgEntryPoint(secondary)));
            }
            updatedGraph.put(entry);
        }
        return updatedGraph;
    });
};
exports.writeBundlesTransform = writeBundlesTransform;
function toCustomNgEntryPoint(entryPoint) {
    return (0, entry_point_1.createNgEntryPoint)(entryPoint.packageJson, entryPoint.ngPackageJson, entryPoint.basePath, 
    // @ts-expect-error this is a TS private property, but it can be accessed at runtime
    entryPoint.secondaryData);
}
